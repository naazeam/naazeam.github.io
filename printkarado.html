<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Customizer - Redesigned</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fabric.js for canvas manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Cropper.js for image cropping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <!-- Google Fonts (initial set) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Lobster&family=Pacifico&family=Bangers&family=Press+Start+2P&family=Oswald&family=Lato&family=Montserrat&family=Raleway&family=Poppins&family=Nunito&family=Merriweather&family=Playfair+Display&family=Dancing+Script&family=Indie+Flower&family=Shadows+Into+Light&family=Amatic+SC&family=Permanent+Marker&family=Caveat&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the new layout */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the body */
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Main container for the editor */
        #editor-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 1rem; 
        }

        /* T-shirt and canvas wrapper */
        #tshirt-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 1rem;
            background-color: white;
        }

        #tshirt-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Prevents the image from being squished */
            border-radius: 1rem;
        }
        
        #c {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .canvas-container {
            width: 100% !important;
            height: 100% !important;
        }

        /* General button styling */
        .control-btn {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #fff;
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .control-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        /* Positioning for controls INSIDE the t-shirt wrapper */
        #delete-control {
            position: absolute;
            top: 1rem;
            left: 1rem;
            transform: scale(0.85);
            transform-origin: top left;
            z-index: 10;
        }
        #history-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            transform: scale(0.85);
            transform-origin: top right;
            z-index: 10;
        }
        #color-presets {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
            transform: scale(0.85);
            transform-origin: bottom right;
        }
        #layer-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transform: scale(0.85);
            transform-origin: bottom left;
            z-index: 10;
        }

        /* Bottom toolbar for adding elements */
        #bottom-toolbar {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        .bottom-toolbar-btn {
            width: 50px;
            height: 50px;
            font-size: 0.75rem;
            flex-direction: column;
            gap: 0.25rem;
        }

        .color-preset-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s ease;
        }
        .color-preset-btn:hover {
            transform: scale(1.1);
        }
        .color-preset-btn.active {
            border-color: #4f46e5;
        }

        /* Contextual controls panel (for text, frames, etc.) */
        #contextual-controls {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30; /* Above bottom toolbar */
            width: 90%;
            max-width: 600px;
        }
        .contextual-panel {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Cropper.js Modal styles */
        .img-container { max-height: 60vh; overflow: hidden; }
        #image-to-crop { display: block; max-width: 100%; }
        .cropper-view-box, .cropper-face { transition: border-radius 0.1s ease; }

        /* Font Gallery Modal */
        #font-gallery-modal {
            max-height: 50vh;
            overflow-y: auto;
        }
        .font-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .font-item:hover, .font-item.selected {
            background-color: #eef2ff;
        }

        /* Emoji Gallery Modal */
        #emoji-gallery {
            max-height: 40vh;
            overflow-y: auto;
        }
        .emoji-btn {
            font-size: 1.75rem;
            line-height: 1;
        }
    </style>
</head>
<body>

    <!-- Main Editor Container -->
    <div id="editor-container">

        <!-- T-Shirt and Canvas Area -->
        <div id="tshirt-wrapper">
            <img src="https://naazeam.github.io/white.png" alt="T-shirt" id="tshirt-image">
            <canvas id="c"></canvas>

            <!-- Controls are now positioned relative to this wrapper -->
            <div id="delete-control">
                <button id="remove-btn" class="control-btn w-12 h-12" disabled title="Delete Selected">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>

            <div id="history-controls">
                <button id="undo-btn" class="control-btn w-12 h-12" disabled title="Undo">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.5 8C9.89 8 7.79 9.21 6.54 11.06L5.5 10.5V15h4.5l-1.59-1.59C9.21 12.39 10.79 11.5 12.5 11.5c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4H6.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5-2.46-5.5-5.5-5.5z"/></svg>
                </button>
                <button id="redo-btn" class="control-btn w-12 h-12" disabled title="Redo">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.4 10.6C16.55 8.79 14.15 8 11.5 8c-3.04 0-5.5 2.46-5.5 5.5h2c0-2.21 1.79-4 4-4s4 1.79 4 4-1.79 4-4 4c-1.71 0-3.29-.81-4.21-2.09L9.5 15H5v-4.5l1.06 1.06C7.21 9.21 9.11 8 11.5 8c2.65 0 5.05.79 6.9 2.6z"/></svg>
                </button>
            </div>

            <div id="layer-controls">
                <button id="bring-forward-btn" class="control-btn w-12 h-12" disabled title="Bring Forward">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                </button>
                <button id="send-backward-btn" class="control-btn w-12 h-12" disabled title="Send Backward">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>

            <div id="color-presets">
                <button class="color-preset-btn bg-white border-2 border-gray-300 active" data-color="#ffffff"></button>
                <button class="color-preset-btn bg-black" data-color="#000000"></button>
                <button class="color-preset-btn bg-red-500" data-color="#ef4444"></button>
                <button class="color-preset-btn bg-blue-500" data-color="#3b82f6"></button>
                <button class="color-preset-btn bg-green-500" data-color="#22c55e"></button>
            </div>
        </div>

    </div>

    <!-- Bottom Toolbar (Add elements) - Remains fixed to viewport -->
    <div id="bottom-toolbar">
        <button id="add-image-btn" class="control-btn bottom-toolbar-btn" title="Add Image">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            <span>Image</span>
        </button>
        <input type="file" id="logo-upload" class="hidden" accept="image/*">
        
        <button id="add-text-btn" class="control-btn bottom-toolbar-btn" title="Add Text">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m0 14V5m-4 0h14M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
            <span>Text</span>
        </button>
        
        <button id="add-emoji-btn" class="control-btn bottom-toolbar-btn" title="Add Emoji">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Emoji</span>
        </button>
        
        <button id="add-frame-btn" class="control-btn bottom-toolbar-btn" title="Add Frame">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z" /></svg>
            <span>Frame</span>
        </button>
    </div>

    <!-- Contextual Controls (hidden by default) -->
    <div id="contextual-controls" class="hidden">
        <!-- Text Controls -->
        <div id="text-controls" class="hidden contextual-panel">
            <div class="flex items-center gap-2 mb-4">
                <button id="font-family-btn" class="control-btn flex-grow p-2">Select Font</button>
                <div class="relative w-12 h-10">
                    <input type="color" id="text-color" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                    <div id="text-color-display" class="w-full h-full rounded-md border border-gray-300" style="background-color: #000000;"></div>
                </div>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <label for="font-size" class="text-sm text-gray-600">Size:</label>
                <input type="range" id="font-size" min="10" max="200" value="40" class="w-full">
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="flex items-center gap-1 rounded-md bg-gray-100 p-1">
                    <button id="bold-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 11h4.5a2.5 2.5 0 1 0 0-5H8v5zm10 4.5a4.5 4.5 0 0 1-4.5 4.5H6V4h8.5a4.5 4.5 0 0 1 0 9H8v3h6.5A2.5 2.5 0 0 0 17 15.5z"/></svg></button>
                    <button id="italic-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 5h8v2h-3.5l-4 10H14v2H6v-2h3.5l4-10H10V5z"/></svg></button>
                    <button id="underline-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 20h12v2H6v-2zM12 4c4.42 0 8 3.58 8 8h-2c0-3.31-2.69-6-6-6s-6 2.69-6 6H4c0-4.42 3.58-8 8-8z"/></svg></button>
                </div>
                <div class="flex items-center gap-1 rounded-md bg-gray-100 p-1">
                    <button id="align-left-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 15h12v2H3v-2zm0-5h18v2H3v-2zm0-5h12v2H3V9z"/></svg></button>
                    <button id="align-center-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm3 15h12v2H6v-2zm-3-5h18v2H3v-2zm3-5h12v2H6V9z"/></svg></button>
                    <button id="align-right-btn" class="control-btn flex-1 p-2"><svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm9 15h9v2h-9v-2zm-9-5h18v2H3v-2zm9-5h9v2h-9V9z"/></svg></button>
                </div>
            </div>
        </div>
        <!-- Frame Controls -->
        <div id="frame-controls" class="hidden contextual-panel">
             <div class="flex items-center gap-2">
                 <label class="text-sm text-gray-600">Color:</label>
                 <div class="relative w-12 h-10">
                     <input type="color" id="frame-color" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                     <div id="frame-color-display" class="w-full h-full rounded-md border border-gray-300" style="background-color: #000000;"></div>
                 </div>
                 <div class="flex-grow"></div>
                 <button id="close-contextual-btn" class="control-btn p-2">Done</button>
             </div>
        </div>
    </div>

    <!-- Modals (hidden by default) -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-40"></div>

    <!-- Cropping Modal -->
    <div id="crop-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full">
            <h3 class="text-xl font-bold mb-4">Crop & Shape Your Image</h3>
            <div class="img-container mb-4"><img id="image-to-crop" src=""></div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700">Corner Radius: <span id="corner-radius-value">0</span>%</label>
                <input type="range" id="corner-radius-slider" min="0" max="100" value="0" class="w-full mt-2">
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-crop-btn" class="px-4 py-2 rounded-md">Cancel</button>
                <button id="done-crop-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Done</button>
            </div>
        </div>
    </div>

    <!-- Generic Modal for Galleries -->
    <div id="gallery-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="gallery-title" class="text-lg font-bold">Select an Item</h3>
                <button id="close-gallery-btn" class="w-8 h-8">&times;</button>
            </div>
            <div id="gallery-content">
                <!-- Content for fonts, emojis, frames will be injected here -->
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State & Constants ---
        let canvas;
        let cropper;
        let editingObject = null;
        let history = [];
        let historyIndex = -1;
        let historyLock = false;
        let touchStartPos = null; // For tap detection
        let touchStartTime = 0;   // For tap detection
        const historyLimit = 20;
        const customProperties = ['customType', 'originalSrc', 'cornerRadiusPercent', 'centeredScaling', 'isGuideline'];
        const googleFonts = ["Roboto", "Lobster", "Pacifico", "Bangers", "Press Start 2P", "Oswald", "Lato", "Montserrat", "Raleway", "Poppins", "Nunito", "Merriweather", "Playfair Display", "Dancing Script", "Indie Flower", "Shadows Into Light", "Amatic SC", "Permanent Marker", "Caveat"];
        const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ˜Ž', 'ðŸ¤”', 'ðŸŽ‰', 'ðŸ¶', 'ðŸ±', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¦„', 'ðŸ¦–', 'ðŸ•', 'ðŸ”', 'ðŸŒ®', 'ï¿½', 'ðŸ¥‘', 'ðŸ“', 'â¤ï¸', 'ðŸ”¥', 'â­', 'ðŸš€', 'ðŸ’»', 'ðŸŽ¸'];

        // --- Element Selectors ---
        const canvasEl = document.getElementById('c');
        const tshirtWrapper = document.getElementById('tshirt-wrapper');
        const tshirtImage = document.getElementById('tshirt-image');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const removeBtn = document.getElementById('remove-btn');
        const bringForwardBtn = document.getElementById('bring-forward-btn');
        const sendBackwardBtn = document.getElementById('send-backward-btn');
        const bottomToolbar = document.getElementById('bottom-toolbar');
        const contextualControls = document.getElementById('contextual-controls');
        const textControls = document.getElementById('text-controls');
        const frameControls = document.getElementById('frame-controls');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const galleryModal = document.getElementById('gallery-modal');
        const galleryTitle = document.getElementById('gallery-title');
        const galleryContent = document.getElementById('gallery-content');

        // --- Canvas Initialization ---
        function initializeCanvas() {
            const { width, height } = tshirtWrapper.getBoundingClientRect();
            
            if (canvas) {
                // Remove old guidelines before resizing
                canvas.getObjects().forEach(obj => {
                    if (obj.isGuideline) {
                        canvas.remove(obj);
                    }
                });
                canvas.setDimensions({ width, height });
            } else {
                canvas = new fabric.Canvas('c', { width, height });
                canvas.on({
                    'object:added': saveState,
                    'object:removed': saveState,
                    'object:modified': saveState,
                    'selection:created': handleSelectionChange,
                    'selection:updated': handleSelectionChange,
                    'selection:cleared': handleSelectionChange,
                    'object:moving': handleSnapping,
                    // --- NEW: Mobile-friendly tap detection ---
                    'mouse:down': (options) => {
                        if (options.target) {
                            touchStartPos = options.pointer;
                            touchStartTime = Date.now();
                        } else {
                            touchStartPos = null;
                        }
                    },
                    'mouse:up': (options) => {
                        if (options.target && touchStartPos) {
                            const touchEndPos = options.pointer;
                            const dist = Math.hypot(touchEndPos.x - touchStartPos.x, touchEndPos.y - touchStartPos.y);
                            const elapsedTime = Date.now() - touchStartTime;

                            // Treat as a "tap" if it's a short press and didn't move much
                            if (elapsedTime < 300 && dist < 10) {
                                const target = options.target;
                                // For text, enter editing mode on tap
                                if (target.customType === 'text' || target.type === 'i-text') {
                                    target.enterEditing();
                                    // Position cursor at the end for convenience
                                    target.selectionStart = target.text.length;
                                    target.selectionEnd = target.text.length;
                                    canvas.renderAll();
                                } 
                                // For images, open the cropper on tap (replaces double-click)
                                else if (target.customType === 'image') {
                                    editingObject = target;
                                    openCropper(editingObject.originalSrc, editingObject.cornerRadiusPercent);
                                }
                            }
                        }
                        touchStartPos = null; // Reset for the next interaction
                    },
                });
            }

            // Add new guidelines
            const guidelineProps = { stroke: '#e0e0e0', strokeDashArray: [5, 5], selectable: false, evented: false, excludeFromExport: true, isGuideline: true };
            const centerLineV = new fabric.Line([width / 2, 0, width / 2, height], guidelineProps);
            const centerLineH = new fabric.Line([0, height / 2, width, height / 2], guidelineProps);
            canvas.add(centerLineV, centerLineH);
            canvas.sendToBack(centerLineV);
            canvas.sendToBack(centerLineH);

            canvas.renderAll();
            if (!history.length) saveState(); // Initial state
        }
        initializeCanvas();
        new ResizeObserver(initializeCanvas).observe(tshirtWrapper);

        // --- History (Undo/Redo) Logic ---
        function updateUndoRedoButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }

        function saveState(e) {
            // Don't save state for guideline modifications
            if (e && e.target && e.target.isGuideline) return;
            if (historyLock) return;
            history = history.slice(0, historyIndex + 1);
            history.push(canvas.toJSON(customProperties));
            historyIndex = history.length - 1;
            if (history.length > historyLimit) {
                history.shift();
                historyIndex--;
            }
            updateUndoRedoButtons();
        }

        function replayState(index) {
            historyLock = true;
            canvas.loadFromJSON(history[index], () => {
                historyLock = false;
                // Re-initialize guidelines after loading state
                initializeCanvas();
                canvas.renderAll();
                updateUndoRedoButtons();
                handleSelectionChange(); // Update controls based on reloaded state
            });
        }
        undoBtn.addEventListener('click', () => historyIndex > 0 && replayState(--historyIndex));
        redoBtn.addEventListener('click', () => historyIndex < history.length - 1 && replayState(++historyIndex));

        // --- T-Shirt Color Controls ---
        const colorPresets = document.getElementById('color-presets');
        const colorToImageMap = {
            '#ffffff': 'https://naazeam.github.io/white.png',
            '#000000': 'https://naazeam.github.io/black.png',
            '#ef4444': 'https://naazeam.github.io/red.png',
            '#3b82f6': 'https://naazeam.github.io/blue.png',
            '#22c55e': 'https://naazeam.github.io/green.png'
        };
        colorPresets.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const color = btn.dataset.color;
            if (color && colorToImageMap[color]) {
                tshirtImage.src = colorToImageMap[color];
                document.querySelectorAll('#color-presets button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        });

        // --- Main Toolbar Logic (Add elements) ---
        document.getElementById('add-image-btn').addEventListener('click', () => document.getElementById('logo-upload').click());
        
        document.getElementById('add-text-btn').addEventListener('click', () => {
             const text = new fabric.IText('Hello', {
                left: canvas.width / 2, top: canvas.height / 2, fontFamily: 'Roboto', fontSize: 50,
                fill: '#000000', originX: 'center', originY: 'center', textAlign: 'center',
                centeredScaling: true, customType: 'text'
            });
            canvas.add(text).setActiveObject(text);
        });

        document.getElementById('add-emoji-btn').addEventListener('click', () => openEmojiGallery());
        document.getElementById('add-frame-btn').addEventListener('click', () => openFrameGallery());

        // --- Selection & Contextual Controls Logic ---
        function handleSelectionChange() {
            const activeObject = canvas.getActiveObject();
            const isObjectSelected = !!activeObject;
            
            removeBtn.disabled = !isObjectSelected;
            bringForwardBtn.disabled = !isObjectSelected;
            sendBackwardBtn.disabled = !isObjectSelected;
            
            contextualControls.classList.add('hidden');
            textControls.classList.add('hidden');
            frameControls.classList.add('hidden');
            bottomToolbar.classList.remove('hidden');

            if (activeObject && activeObject.isEditing) {
                 // If an object is in editing mode, keep its controls visible
                 bottomToolbar.classList.add('hidden');
                 contextualControls.classList.remove('hidden');
                 if (activeObject.customType === 'text') {
                     textControls.classList.remove('hidden');
                 }
            } else if (activeObject && activeObject.type !== 'activeSelection') {
                bottomToolbar.classList.add('hidden');
                contextualControls.classList.remove('hidden');
                
                if (activeObject.customType === 'text') {
                    updateTextControls(activeObject);
                    textControls.classList.remove('hidden');
                } else if (activeObject.customType === 'frame') {
                    updateFrameControls(activeObject);
                    frameControls.classList.remove('hidden');
                }
            }
        }
        
        document.getElementById('close-contextual-btn')?.addEventListener('click', () => canvas.discardActiveObject().renderAll());

        // --- Text Controls ---
        function updateTextControls(obj) {
            document.getElementById('text-color').value = obj.get('fill');
            document.getElementById('text-color-display').style.backgroundColor = obj.get('fill');
            document.getElementById('font-size').value = obj.get('fontSize');
            document.getElementById('bold-btn').classList.toggle('active', obj.get('fontWeight') === 'bold');
            document.getElementById('italic-btn').classList.toggle('active', obj.get('fontStyle') === 'italic');
            document.getElementById('underline-btn').classList.toggle('active', obj.get('underline'));
            ['left', 'center', 'right'].forEach(align => {
                document.getElementById(`align-${align}-btn`).classList.toggle('active', obj.get('textAlign') === align);
            });
        }

        document.getElementById('text-color').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'text') {
                activeObject.set('fill', e.target.value);
                document.getElementById('text-color-display').style.backgroundColor = e.target.value;
                canvas.renderAll();
            }
        });
        document.getElementById('font-size').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'text') {
                activeObject.set('fontSize', parseInt(e.target.value, 10));
                canvas.renderAll();
            }
        });
        document.getElementById('bold-btn').addEventListener('click', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'text') {
                const isBold = activeObject.get('fontWeight') === 'bold';
                activeObject.set('fontWeight', isBold ? 'normal' : 'bold');
                e.currentTarget.classList.toggle('active');
                canvas.renderAll();
            }
        });
        document.getElementById('italic-btn').addEventListener('click', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'text') {
                const isItalic = activeObject.get('fontStyle') === 'italic';
                activeObject.set('fontStyle', isItalic ? 'normal' : 'italic');
                e.currentTarget.classList.toggle('active');
                canvas.renderAll();
            }
        });
        document.getElementById('underline-btn').addEventListener('click', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'text') {
                activeObject.set('underline', !activeObject.get('underline'));
                e.currentTarget.classList.toggle('active');
                canvas.renderAll();
            }
        });
        ['left', 'center', 'right'].forEach(align => {
            document.getElementById(`align-${align}-btn`).addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject?.customType === 'text') {
                    activeObject.set('textAlign', align);
                    handleSelectionChange(); // to update active state of buttons
                    canvas.renderAll();
                }
            });
        });
        document.getElementById('font-family-btn').addEventListener('click', () => openFontGallery());

        // --- Frame Controls ---
        function updateFrameControls(obj) {
            const stroke = obj.type === 'group' ? (obj._objects[0]?.stroke || '#000000') : obj.stroke;
            document.getElementById('frame-color').value = stroke;
            document.getElementById('frame-color-display').style.backgroundColor = stroke;
        }

        document.getElementById('frame-color').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject?.customType === 'frame') {
                const color = e.target.value;
                document.getElementById('frame-color-display').style.backgroundColor = color;
                if (activeObject.type === 'group') {
                    activeObject.forEachObject(obj => obj.set('stroke', color));
                } else {
                    activeObject.set('stroke', color);
                }
                canvas.renderAll();
            }
        });

        // --- General Controls (Remove, Layering) ---
        removeBtn.addEventListener('click', () => {
            canvas.getActiveObjects().forEach(obj => canvas.remove(obj));
            canvas.discardActiveObject().renderAll();
        });
        
        bringForwardBtn.addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.bringForward(activeObject);
                canvas.renderAll();
            }
        });

        sendBackwardBtn.addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.sendBackwards(activeObject);
                // Ensure it doesn't go behind guidelines
                canvas.getObjects().forEach(obj => {
                    if (obj.isGuideline) {
                        canvas.sendToBack(obj);
                    }
                });
                canvas.renderAll();
            }
        });
        
        // --- Snapping Logic ---
        function handleSnapping(options) {
            const obj = options.target;
            const snappingThreshold = 8;
            const canvasCenterX = canvas.getCenter().left;
            const canvasCenterY = canvas.getCenter().top;
            const objCenter = obj.getCenterPoint();

            // Snap to horizontal center
            if (Math.abs(objCenter.x - canvasCenterX) < snappingThreshold) {
                obj.set({ left: canvasCenterX }).setCoords();
            }

            // Snap to vertical center
            if (Math.abs(objCenter.y - canvasCenterY) < snappingThreshold) {
                obj.set({ top: canvasCenterY }).setCoords();
            }
        }

        // --- Modal & Gallery Logic ---
        function openModal() {
            modalBackdrop.classList.remove('hidden');
            galleryModal.classList.remove('hidden');
        }
        function closeModal() {
            modalBackdrop.classList.add('hidden');
            galleryModal.classList.add('hidden');
            galleryContent.innerHTML = '';
        }
        modalBackdrop.addEventListener('click', closeModal);
        document.getElementById('close-gallery-btn').addEventListener('click', closeModal);

        function openFontGallery() {
            galleryTitle.textContent = 'Select a Font';
            const activeObject = canvas.getActiveObject();
            const selectedFont = activeObject ? activeObject.get('fontFamily') : 'Roboto';
            
            const content = document.createElement('div');
            content.id = 'font-gallery-modal';
            googleFonts.forEach(font => {
                const item = document.createElement('div');
                item.className = 'font-item';
                if (font === selectedFont) item.classList.add('selected');
                item.textContent = font;
                item.style.fontFamily = font;
                item.addEventListener('click', () => {
                    if (activeObject?.customType === 'text') {
                        activeObject.set('fontFamily', font);
                        canvas.renderAll();
                    }
                    closeModal();
                });
                content.appendChild(item);
            });
            galleryContent.appendChild(content);
            openModal();
        }

        function openEmojiGallery() {
            galleryTitle.textContent = 'Select an Emoji';
            const content = document.createElement('div');
            content.id = 'emoji-gallery';
            content.className = 'grid grid-cols-6 gap-2 p-2';
            emojis.forEach(emojiChar => {
                const btn = document.createElement('button');
                btn.className = 'control-btn emoji-btn p-2 rounded-md';
                btn.textContent = emojiChar;
                btn.addEventListener('click', () => {
                    const emoji = new fabric.IText(emojiChar, {
                        left: canvas.width / 2, top: canvas.height / 2, fontSize: 80,
                        originX: 'center', originY: 'center', centeredScaling: true, customType: 'text'
                    });
                    canvas.add(emoji).setActiveObject(emoji);
                    closeModal();
                });
                content.appendChild(btn);
            });
            galleryContent.appendChild(content);
            openModal();
        }

        function openFrameGallery() {
            galleryTitle.textContent = 'Select a Frame';
            const frames = [
                { name: 'Curvy', type: 'rounded', icon: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="5" ry="5"></rect></svg>' },
                { name: 'Square', type: 'square', icon: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18"></rect></svg>' },
                { name: 'Wavy', type: 'wavy', icon: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6.5C3 6.5 4.5 8 6 8C7.5 8 9 6.5 10.5 6.5C12 6.5 13.5 8 15 8C16.5 8 18 6.5 19.5 6.5C21 6.5 21 6.5 21 6.5M21 17.5C21 17.5 19.5 16 18 16C16.5 16 15 17.5 13.5 17.5C12 17.5 10.5 16 9 16C7.5 16 6 17.5 4.5 17.5C3 17.5 3 17.5 3 17.5M3 17.5V6.5M21 17.5V6.5"/></svg>' },
                { name: 'Double Wavy', type: 'double-wavy', icon: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8.5C3 8.5 4.5 10 6 10C7.5 10 9 8.5 10.5 8.5C12 8.5 13.5 10 15 10C16.5 10 18 8.5 19.5 8.5C21 8.5 21 8.5 21 8.5M3 15.5C3 15.5 4.5 14 6 14C7.5 14 9 15.5 10.5 15.5C12 15.5 13.5 14 15 14C16.5 14 18 15.5 19.5 15.5C21 15.5 21 15.5 21 15.5M3 5.5C3 5.5 4.5 7 6 7C7.5 7 9 5.5 10.5 5.5C12 5.5 13.5 7 15 7C16.5 7 18 5.5 19.5 5.5C21 5.5 21 5.5 21 5.5M3 18.5C3 18.5 4.5 17 6 17C7.5 17 9 18.5 10.5 18.5C12 18.5 13.5 17 15 17C16.5 17 18 18.5 19.5 18.5C21 18.5 21 18.5 21 18.5"/></svg>' }
            ];
            const content = document.createElement('div');
            content.className = 'grid grid-cols-2 gap-4 p-4';
            frames.forEach(({ name, type, icon }) => {
                const btn = document.createElement('button');
                btn.className = 'control-btn flex-col h-24 gap-2';
                btn.innerHTML = `${icon}<span class="text-xs">${name}</span>`;
                btn.addEventListener('click', () => { addFrame(type); closeModal(); });
                content.appendChild(btn);
            });
            galleryContent.appendChild(content);
            openModal();
        }

        function addFrame(type) {
            const commonProps = {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fill: 'transparent', stroke: '#000000', strokeWidth: 5, customType: 'frame', centeredScaling: true
            };
            if (type === 'rounded' || type === 'square') {
                const frame = new fabric.Rect({ ...commonProps, width: 250, height: 250, rx: type === 'rounded' ? 30 : 0, ry: type === 'rounded' ? 30 : 0 });
                canvas.add(frame).setActiveObject(frame);
            } else {
                let svgString = '';
                if (type === 'wavy') svgString = `<svg width="300" height="300" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M5 15 C 5 15, 20 5, 35 15 S 65 25, 80 15 S 95 5, 95 5 V 95 C 95 95, 80 85, 65 95 S 35 85, 20 95 S 5 85, 5 85 V 15 Z" fill="transparent" stroke="black" stroke-width="2"/></svg>`;
                if (type === 'double-wavy') svgString = `<svg width="300" height="300" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke="black" stroke-width="1.5" fill="transparent"><path d="M5 15 C 5 15, 20 5, 35 15 S 65 25, 80 15 S 95 5, 95 5 V 95 C 95 95, 80 85, 65 95 S 35 85, 20 95 S 5 85, 5 85 V 15 Z" /><path d="M10 20 C 10 20, 23 12, 35 20 S 65 28, 77 20 S 90 12, 90 12 V 88 C 90 88, 77 82, 65 88 S 35 82, 23 88 S 10 82, 10 82 V 20 Z" /></g></svg>`;
                fabric.loadSVGFromString(svgString, (objects, options) => {
                    const frame = fabric.util.groupSVGElements(objects, options);
                    frame.set({ ...commonProps, strokeWidth: 2 });
                    canvas.add(frame).setActiveObject(frame);
                });
            }
        }

        // --- Image Cropping Logic ---
        const logoUpload = document.getElementById('logo-upload');
        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const cornerRadiusSlider = document.getElementById('corner-radius-slider');
        
        logoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => openCropper(event.target.result, 0);
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        function openCropper(src, radiusPercent) {
            imageToCrop.src = src;
            cropModal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, { viewMode: 1, background: false, autoCrop: true });
            cornerRadiusSlider.value = radiusPercent;
            document.getElementById('corner-radius-value').textContent = radiusPercent;
        }

        function closeCropper() {
            cropModal.classList.add('hidden');
            modalBackdrop.classList.add('hidden');
            if (cropper) cropper.destroy();
            cropper = null;
            editingObject = null;
        }

        cornerRadiusSlider.addEventListener('input', (e) => {
            document.getElementById('corner-radius-value').textContent = e.target.value;
            const viewBox = document.querySelector('.cropper-view-box');
            if (viewBox) viewBox.style.borderRadius = `${e.target.value / 2}%`;
        });

        document.getElementById('cancel-crop-btn').addEventListener('click', closeCropper);
        document.getElementById('done-crop-btn').addEventListener('click', () => {
            if (!cropper) return;
            const sourceCanvas = cropper.getCroppedCanvas();
            const radiusPercent = parseInt(cornerRadiusSlider.value, 10);
            const radius = (Math.min(sourceCanvas.width, sourceCanvas.height) / 2) * (radiusPercent / 100);
            const destCanvas = document.createElement('canvas');
            destCanvas.width = sourceCanvas.width;
            destCanvas.height = sourceCanvas.height;
            const ctx = destCanvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(radius, 0);
            ctx.arcTo(destCanvas.width, 0, destCanvas.width, destCanvas.height, radius);
            ctx.arcTo(destCanvas.width, destCanvas.height, 0, destCanvas.height, radius);
            ctx.arcTo(0, destCanvas.height, 0, 0, radius);
            ctx.arcTo(0, 0, destCanvas.width, 0, radius);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(sourceCanvas, 0, 0);
            const finalImageDataUrl = destCanvas.toDataURL('image/png');

            if (editingObject) canvas.remove(editingObject);
            
            fabric.Image.fromURL(finalImageDataUrl, (img) => {
                img.scaleToWidth(editingObject ? editingObject.getScaledWidth() : 150);
                img.set({
                    left: editingObject ? editingObject.left : canvas.width / 2,
                    top: editingObject ? editingObject.top : canvas.height / 2,
                    angle: editingObject ? editingObject.angle : 0,
                    originX: 'center', originY: 'center', customType: 'image',
                    centeredScaling: true, originalSrc: imageToCrop.src, cornerRadiusPercent: radiusPercent
                });
                canvas.add(img).setActiveObject(img);
            });
            closeCropper();
        });
    });
    </script>

</body>
</html>
