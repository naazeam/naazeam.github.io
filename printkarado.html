<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Customizer with Frames</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fabric.js for canvas manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Cropper.js for image cropping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <!-- Google Fonts (initial set) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Lobster&family=Pacifico&family=Bangers&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Roboto', sans-serif;
        }
        .canvas-container {
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Ensures canvas corners are rounded */
        }
        .control-panel {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .control-heading {
            font-weight: 700;
            font-size: 1.125rem;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .input-file-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .color-picker-wrapper {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            transform: translate(-7px, -7px);
        }
        /* Cropper.js container style */
        .img-container {
            max-height: 60vh;
            overflow: hidden;
        }
        #image-to-crop {
            display: block;
            max-width: 100%;
        }
        .frame-btn, .emoji-btn {
            background-color: #f3f4f6;
            color: #374151;
        }
        .frame-btn:hover, .emoji-btn:hover {
            background-color: #e5e7eb;
        }
        .emoji-btn {
            font-size: 1.75rem;
            line-height: 1;
        }
        /* Style for the live preview of rounded corners in Cropper */
        .cropper-view-box, .cropper-face {
            transition: border-radius 0.1s ease;
        }
        /* Style for active text control buttons */
        .control-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Font Gallery Styles */
        #font-gallery {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }
        .font-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .font-item:hover, .font-item.selected {
            background-color: #eef2ff;
        }
        .font-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl lg:text-5xl font-bold text-gray-800">T-Shirt Design Studio</h1>
            <p class="text-gray-500 mt-2">Create your unique T-shirt design in seconds!</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- T-Shirt Canvas Area -->
            <div class="w-full lg:w-2/3 relative flex items-center justify-center">
                <div id="tshirt-container" class="relative w-full max-w-xl" style="aspect-ratio: 1/1;">
                    <img src="https://naazeam.github.io/white.png" alt="T-shirt" id="tshirt-image" class="absolute inset-0 w-full h-full object-contain">
                    <canvas id="c" class="absolute inset-0 w-full h-full"></canvas>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="w-full lg:w-1/3 p-6 control-panel">
                <h2 class="control-heading">Customize Your T-Shirt</h2>

                <!-- T-Shirt Color -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">T-Shirt Color:</label>
                    <div id="color-presets" class="flex items-center gap-2">
                        <button class="w-8 h-8 rounded-full bg-white border-2 border-gray-300" data-color="#ffffff"></button>
                        <button class="w-8 h-8 rounded-full bg-black" data-color="#000000"></button>
                        <button class="w-8 h-8 rounded-full bg-red-500" data-color="#ef4444"></button>
                        <button class="w-8 h-8 rounded-full bg-blue-500" data-color="#3b82f6"></button>
                        <button class="w-8 h-8 rounded-full bg-green-500" data-color="#22c55e"></button>
                    </div>
                </div>

                <!-- Add Text -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add Text:</label>
                    <div class="flex gap-2">
                        <input type="text" id="text-input" class="flex-grow block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Your Text Here">
                        <button id="add-text-btn" class="btn bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700">Add</button>
                    </div>
                </div>

                <!-- Text Controls (shown when text is selected) -->
                <div id="text-controls" class="hidden space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-600">Text Options</h3>
                    <!-- Font Gallery -->
                    <div>
                        <label for="font-search" class="block text-sm font-medium text-gray-700">Font Family:</label>
                        <input type="text" id="font-search" placeholder="Search fonts..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm mb-2">
                        <div id="font-gallery">
                            <!-- Font items will be dynamically inserted here -->
                        </div>
                    </div>
                    <!-- Color & Size -->
                    <div class="flex items-center gap-4">
                        <div>
                           <label for="text-color" class="block text-sm font-medium text-gray-700">Color:</label>
                           <div class="color-picker-wrapper mt-1">
                               <input type="color" id="text-color" value="#000000">
                           </div>
                        </div>
                        <div class="flex-grow">
                            <label for="font-size" class="block text-sm font-medium text-gray-700">Font Size:</label>
                            <input type="range" id="font-size" min="10" max="200" value="40" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                        </div>
                    </div>
                    <!-- Style & Alignment -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Style</label>
                            <div class="flex items-center gap-1 rounded-md shadow-sm bg-white border border-gray-300 p-1">
                                <button id="bold-btn" class="control-btn flex-1 p-2 rounded-sm" title="Bold">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 11h4.5a2.5 2.5 0 1 0 0-5H8v5zm10 4.5a4.5 4.5 0 0 1-4.5 4.5H6V4h8.5a4.5 4.5 0 0 1 0 9H8v3h6.5A2.5 2.5 0 0 0 17 15.5z"/></svg>
                                </button>
                                <button id="italic-btn" class="control-btn flex-1 p-2 rounded-sm" title="Italic">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 5h8v2h-3.5l-4 10H14v2H6v-2h3.5l4-10H10V5z"/></svg>
                                </button>
                                <button id="underline-btn" class="control-btn flex-1 p-2 rounded-sm" title="Underline">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 20h12v2H6v-2zM12 4c4.42 0 8 3.58 8 8h-2c0-3.31-2.69-6-6-6s-6 2.69-6 6H4c0-4.42 3.58-8 8-8z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alignment</label>
                            <div class="flex items-center gap-1 rounded-md shadow-sm bg-white border border-gray-300 p-1">
                                <button id="align-left-btn" class="control-btn flex-1 p-2 rounded-sm" title="Align Left">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 15h12v2H3v-2zm0-5h18v2H3v-2zm0-5h12v2H3V9z"/></svg>
                                </button>
                                <button id="align-center-btn" class="control-btn flex-1 p-2 rounded-sm" title="Align Center">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm3 15h12v2H6v-2zm-3-5h18v2H3v-2zm3-5h12v2H6V9z"/></svg>
                                </button>
                                <button id="align-right-btn" class="control-btn flex-1 p-2 rounded-sm" title="Align Right">
                                    <svg class="mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm9 15h9v2h-9v-2zm-9-5h18v2H3v-2zm9-5h9v2h-9V9z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
              
                <!-- Frame Controls -->
                <div id="frame-controls" class="hidden space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-600">Frame Options</h3>
                    <div class="flex items-center gap-4">
                        <div>
                           <label for="frame-color" class="block text-sm font-medium text-gray-700">Frame Color:</label>
                           <div class="color-picker-wrapper mt-1">
                               <input type="color" id="frame-color" value="#000000">
                           </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Logo -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image:</label>
                    <label for="logo-upload" class="btn input-file-btn inline-block text-center">Choose File</label>
                    <input type="file" id="logo-upload" class="hidden" accept="image/*">
                    <p class="text-xs text-gray-500 mt-1">PNG, JPG, SVG accepted.</p>
                </div>
              
                <!-- Add a Frame -->
                <div class="mb-6 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add a Frame:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="add-rounded-frame-btn" class="btn frame-btn p-2 rounded-md flex items-center justify-center flex-col h-20">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="5" ry="5"></rect></svg>
                            <span class="text-xs mt-1">Curvy</span>
                        </button>
                        <button id="add-square-frame-btn" class="btn frame-btn p-2 rounded-md flex items-center justify-center flex-col h-20">
                             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18"></rect></svg>
                            <span class="text-xs mt-1">Square</span>
                        </button>
                        <button id="add-wavy-frame-btn" class="btn frame-btn p-2 rounded-md flex items-center justify-center flex-col h-20" data-frame-type="wavy">
                            <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6.5C3 6.5 4.5 8 6 8C7.5 8 9 6.5 10.5 6.5C12 6.5 13.5 8 15 8C16.5 8 18 6.5 19.5 6.5C21 6.5 21 6.5 21 6.5M21 17.5C21 17.5 19.5 16 18 16C16.5 16 15 17.5 13.5 17.5C12 17.5 10.5 16 9 16C7.5 16 6 17.5 4.5 17.5C3 17.5 3 17.5 3 17.5M3 17.5V6.5M21 17.5V6.5"/></svg>
                            <span class="text-xs mt-1 pointer-events-none">Wavy</span>
                        </button>
                        <button id="add-double-wavy-frame-btn" class="btn frame-btn p-2 rounded-md flex items-center justify-center flex-col h-20" data-frame-type="double-wavy">
                             <svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 8.5C3 8.5 4.5 10 6 10C7.5 10 9 8.5 10.5 8.5C12 8.5 13.5 10 15 10C16.5 10 18 8.5 19.5 8.5C21 8.5 21 8.5 21 8.5M3 15.5C3 15.5 4.5 14 6 14C7.5 14 9 15.5 10.5 15.5C12 15.5 13.5 14 15 14C16.5 14 18 15.5 19.5 15.5C21 15.5 21 15.5 21 15.5M3 5.5C3 5.5 4.5 7 6 7C7.5 7 9 5.5 10.5 5.5C12 5.5 13.5 7 15 7C16.5 7 18 5.5 19.5 5.5C21 5.5 21 5.5 21 5.5M3 18.5C3 18.5 4.5 17 6 17C7.5 17 9 18.5 10.5 18.5C12 18.5 13.5 17 15 17C16.5 17 18 18.5 19.5 18.5C21 18.5 21 18.5 21 18.5"/></svg>
                            <span class="text-xs mt-1 pointer-events-none">Double Wavy</span>
                        </button>
                    </div>
                </div>

                <!-- NEW: Add an Emoji -->
                <div class="mb-6 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add an Emoji:</label>
                    <div id="emoji-gallery" class="grid grid-cols-6 gap-2">
                        <!-- Emoji buttons will be dynamically inserted here -->
                    </div>
                </div>

                <!-- General Controls -->
                <div class="pt-4 border-t space-y-2">
                    <h3 class="text-sm font-bold text-gray-600">Actions</h3>
                    <button id="remove-btn" class="btn w-full bg-red-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-red-700" disabled>
                        Remove Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cropping Modal -->
    <div id="crop-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full">
            <h3 class="text-xl font-bold mb-4">Crop & Shape Your Image</h3>
            <div class="img-container mb-4">
                <img id="image-to-crop" src="">
            </div>
            <div class="mb-6">
                <label for="corner-radius-slider" class="block text-sm font-medium text-gray-700">Corner Radius: <span id="corner-radius-value">0</span>%</label>
                <input type="range" id="corner-radius-slider" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="replace-btn-modal" class="btn bg-gray-500 text-white px-4 py-2 rounded-md shadow-sm hover:bg-gray-600">Replace</button>
                <button id="cancel-crop-btn" class="btn bg-red-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-red-700">Cancel</button>
                <button id="done-crop-btn" class="btn bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700">Done</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State ---
            let canvas;
            let cropper;
            let editingObject = null;

            // --- Google Fonts & Emojis ---
            const googleFonts = [
                "Roboto", "Lobster", "Pacifico", "Bangers", "Press Start 2P", "Oswald", "Lato", "Montserrat",
                "Raleway", "Poppins", "Nunito", "Merriweather", "Playfair Display", "Dancing Script",
                "Indie Flower", "Shadows Into Light", "Amatic SC", "Permanent Marker", "Caveat"
            ];
            const emojis = [
                'ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ˜Ž', 'ðŸ¤”', 'ðŸ˜´', 'ðŸ¶', 'ðŸ±', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¦„', 'ðŸ¦–',
                'ðŸ•', 'ðŸ”', 'ðŸŒ®', 'ðŸ©', 'ðŸ¥‘', 'ðŸ“', 'â¤ï¸', 'ðŸ”¥', 'â­', 'ðŸš€', 'ðŸ’»', 'ðŸŽ¸'
            ];

            // --- Canvas & T-shirt Setup ---
            const canvasEl = document.getElementById('c');
            const tshirtContainer = document.getElementById('tshirt-container');
            const tshirtImage = document.getElementById('tshirt-image');
            
            function initializeCanvas() {
                const { width, height } = tshirtContainer.getBoundingClientRect();
                canvasEl.width = width;
                canvasEl.height = height;

                if (canvas) {
                    canvas.setDimensions({ width, height });
                } else {
                    canvas = new fabric.Canvas('c', { width, height });
                }
                
                const centerLineV = new fabric.Line([canvas.width / 2, 0, canvas.width / 2, canvas.height], { stroke: '#e0e0e0', strokeDashArray: [5, 5], selectable: false, evented: false });
                const centerLineH = new fabric.Line([0, canvas.height / 2, canvas.width, canvas.height / 2], { stroke: '#e0e0e0', strokeDashArray: [5, 5], selectable: false, evented: false });
                canvas.add(centerLineV, centerLineH);
                canvas.sendToBack(centerLineV);
                canvas.sendToBack(centerLineH);
            }
            
            initializeCanvas();
            window.addEventListener('resize', initializeCanvas);

            // --- T-Shirt Color Controls ---
            const colorPresets = document.getElementById('color-presets');
            const colorToImageMap = {
                '#ffffff': 'https://naazeam.github.io/white.png',
                '#000000': 'https://naazeam.github.io/black.png',
                '#ef4444': 'https://naazeam.github.io/red.png',
                '#3b82f6': 'https://naazeam.github.io/blue.png',
                '#22c55e': 'https://naazeam.github.io/green.png'
            };
            colorPresets.addEventListener('click', (e) => {
                const color = e.target.dataset.color;
                if (color && colorToImageMap[color]) {
                    tshirtImage.src = colorToImageMap[color];
                }
            });

            // --- Text Control Elements ---
            const textControls = document.getElementById('text-controls');
            const fontSearchInput = document.getElementById('font-search');
            const fontGallery = document.getElementById('font-gallery');
            const textColorInput = document.getElementById('text-color');
            const fontSizeInput = document.getElementById('font-size');
            const boldBtn = document.getElementById('bold-btn');
            const italicBtn = document.getElementById('italic-btn');
            const underlineBtn = document.getElementById('underline-btn');
            const alignLeftBtn = document.getElementById('align-left-btn');
            const alignCenterBtn = document.getElementById('align-center-btn');
            const alignRightBtn = document.getElementById('align-right-btn');
            const alignmentButtons = [alignLeftBtn, alignCenterBtn, alignRightBtn];

            // --- Frame Control Elements ---
            const frameControls = document.getElementById('frame-controls');
            const frameColorInput = document.getElementById('frame-color');

            // --- DYNAMIC CONTROL PANEL VISIBILITY ---
            function updateDynamicControls(activeObject) {
                const type = activeObject ? activeObject.customType : null;
                
                textControls.classList.add('hidden');
                frameControls.classList.add('hidden');

                if (activeObject && activeObject.type !== 'activeSelection' && type === 'text') {
                    populateFontGallery(activeObject.get('fontFamily'));
                    textColorInput.value = activeObject.get('fill');
                    fontSizeInput.value = activeObject.get('fontSize');
                    
                    boldBtn.classList.toggle('active', activeObject.get('fontWeight') === 'bold');
                    italicBtn.classList.toggle('active', activeObject.get('fontStyle') === 'italic');
                    underlineBtn.classList.toggle('active', activeObject.get('underline') === true);

                    const currentAlign = activeObject.get('textAlign');
                    alignmentButtons.forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`align-${currentAlign}-btn`)?.classList.add('active');
                    
                    textControls.classList.remove('hidden');

                } else if (activeObject && activeObject.type !== 'activeSelection' && type === 'frame') {
                    const stroke = activeObject.type === 'group' 
                        ? activeObject._objects[0].stroke 
                        : activeObject.stroke;
                    frameColorInput.value = stroke;
                    frameControls.classList.remove('hidden');
                }
            }

            // --- Text Logic ---
            const textInput = document.getElementById('text-input');
            const addTextBtn = document.getElementById('add-text-btn');

            function loadGoogleFont(font) {
                const fontName = font.replace(/ /g, '+');
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `https://fonts.googleapis.com/css2?family=${fontName}&display=swap`;
                document.head.appendChild(link);
            }

            function populateFontGallery(selectedFont = 'Roboto', filter = '') {
                fontGallery.innerHTML = '';
                const filteredFonts = googleFonts.filter(font => font.toLowerCase().includes(filter.toLowerCase()));
                
                filteredFonts.forEach(font => {
                    loadGoogleFont(font);
                    const item = document.createElement('div');
                    item.className = 'font-item';
                    if (font === selectedFont) {
                        item.classList.add('selected');
                    }
                    item.textContent = font;
                    item.style.fontFamily = font;
                    item.dataset.font = font;
                    item.addEventListener('click', () => {
                        const activeObject = canvas.getActiveObject();
                        if (activeObject && activeObject.customType === 'text') {
                            activeObject.set('fontFamily', font);
                            canvas.renderAll();
                            document.querySelectorAll('.font-item').forEach(el => el.classList.remove('selected'));
                            item.classList.add('selected');
                        }
                    });
                    fontGallery.appendChild(item);
                });
            }

            fontSearchInput.addEventListener('input', (e) => {
                const activeObject = canvas.getActiveObject();
                const selectedFont = activeObject ? activeObject.get('fontFamily') : 'Roboto';
                populateFontGallery(selectedFont, e.target.value);
            });

            addTextBtn.addEventListener('click', () => {
                const textValue = textInput.value;
                if (!textValue) return;
                const text = new fabric.IText(textValue, {
                    left: canvas.width / 2,
                    top: canvas.height / 3,
                    fontFamily: 'Roboto',
                    fontSize: 40,
                    fill: '#000000',
                    originX: 'center',
                    originY: 'center',
                    textAlign: 'center',
                    customType: 'text'
                });
                canvas.add(text);
                canvas.setActiveObject(text);
                textInput.value = '';
            });

            textColorInput.addEventListener('input', (e) => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    activeObject.set('fill', e.target.value);
                    canvas.renderAll();
                }
            });
            
            fontSizeInput.addEventListener('input', (e) => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    activeObject.set('fontSize', parseInt(e.target.value, 10));
                    canvas.renderAll();
                }
            });

            boldBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    const isBold = activeObject.get('fontWeight') === 'bold';
                    activeObject.set('fontWeight', isBold ? 'normal' : 'bold');
                    boldBtn.classList.toggle('active');
                    canvas.renderAll();
                }
            });

            italicBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    const isItalic = activeObject.get('fontStyle') === 'italic';
                    activeObject.set('fontStyle', isItalic ? 'normal' : 'italic');
                    italicBtn.classList.toggle('active');
                    canvas.renderAll();
                }
            });

            underlineBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    const isUnderline = activeObject.get('underline') === true;
                    activeObject.set('underline', !isUnderline);
                    underlineBtn.classList.toggle('active');
                    canvas.renderAll();
                }
            });
            
            function setTextAlign(align) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'text') {
                    activeObject.set('textAlign', align);
                    alignmentButtons.forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`align-${align}-btn`).classList.add('active');
                    canvas.renderAll();
                }
            }

            alignLeftBtn.addEventListener('click', () => setTextAlign('left'));
            alignCenterBtn.addEventListener('click', () => setTextAlign('center'));
            alignRightBtn.addEventListener('click', () => setTextAlign('right'));

            // --- Emoji Logic ---
            const emojiGallery = document.getElementById('emoji-gallery');
            
            function populateEmojiGallery() {
                emojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'btn emoji-btn p-2 rounded-md';
                    btn.textContent = emoji;
                    btn.dataset.emoji = emoji;
                    emojiGallery.appendChild(btn);
                });
            }

            emojiGallery.addEventListener('click', (e) => {
                const emojiChar = e.target.dataset.emoji;
                if (emojiChar) {
                    const emoji = new fabric.IText(emojiChar, {
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        fontSize: 80,
                        originX: 'center',
                        originY: 'center',
                        customType: 'text' // Treat emojis as text to use the same controls
                    });
                    canvas.add(emoji);
                    canvas.setActiveObject(emoji);
                }
            });


            // --- Frame Logic ---
            const addRoundedFrameBtn = document.getElementById('add-rounded-frame-btn');
            const addSquareFrameBtn = document.getElementById('add-square-frame-btn');
            const addWavyFrameBtn = document.getElementById('add-wavy-frame-btn');
            const addDoubleWavyFrameBtn = document.getElementById('add-double-wavy-frame-btn');

            const addFrame = (type) => {
                let frame;
                const commonProps = {
                    left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                    fill: 'transparent', stroke: '#000000', strokeWidth: 5, customType: 'frame'
                };
                switch (type) {
                    case 'rounded': frame = new fabric.Rect({ ...commonProps, width: 250, height: 250, rx: 30, ry: 30 }); break;
                    case 'square': frame = new fabric.Rect({ ...commonProps, width: 250, height: 250 }); break;
                }
                canvas.add(frame);
                canvas.setActiveObject(frame);
            };

            const addSvgFrame = (frameType) => {
                let svgString = '';
                if(frameType === 'wavy') {
                    svgString = `<svg width="300" height="300" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M5 15 C 5 15, 20 5, 35 15 S 65 25, 80 15 S 95 5, 95 5 V 95 C 95 95, 80 85, 65 95 S 35 85, 20 95 S 5 85, 5 85 V 15 Z" fill="transparent" stroke="black" stroke-width="2"/></svg>`;
                } else if (frameType === 'double-wavy') {
                    svgString = `<svg width="300" height="300" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g stroke="black" stroke-width="1.5" fill="transparent"><path d="M5 15 C 5 15, 20 5, 35 15 S 65 25, 80 15 S 95 5, 95 5 V 95 C 95 95, 80 85, 65 95 S 35 85, 20 95 S 5 85, 5 85 V 15 Z" /><path d="M10 20 C 10 20, 23 12, 35 20 S 65 28, 77 20 S 90 12, 90 12 V 88 C 90 88, 77 82, 65 88 S 35 82, 23 88 S 10 82, 10 82 V 20 Z" /></g></svg>`;
                }
                fabric.loadSVGFromString(svgString, (objects, options) => {
                    const frame = fabric.util.groupSVGElements(objects, options);
                    frame.set({ left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center', customType: 'frame' });
                    canvas.add(frame);
                    canvas.setActiveObject(frame);
                });
            };

            addRoundedFrameBtn.addEventListener('click', () => addFrame('rounded'));
            addSquareFrameBtn.addEventListener('click', () => addFrame('square'));
            addWavyFrameBtn.addEventListener('click', (e) => addSvgFrame(e.currentTarget.dataset.frameType));
            addDoubleWavyFrameBtn.addEventListener('click', (e) => addSvgFrame(e.currentTarget.dataset.frameType));

            frameColorInput.addEventListener('input', (e) => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.customType === 'frame') {
                    if (activeObject.type === 'group') {
                        activeObject.forEachObject(obj => obj.set('stroke', e.target.value));
                    } else {
                        activeObject.set('stroke', e.target.value);
                    }
                    canvas.renderAll();
                }
            });

            // --- Image/Logo & Cropping Logic ---
            const logoUpload = document.getElementById('logo-upload');
            const cropModal = document.getElementById('crop-modal');
            const imageToCrop = document.getElementById('image-to-crop');
            const cancelCropBtn = document.getElementById('cancel-crop-btn');
            const replaceBtnModal = document.getElementById('replace-btn-modal');
            const doneCropBtn = document.getElementById('done-crop-btn');
            const cornerRadiusSlider = document.getElementById('corner-radius-slider');
            const cornerRadiusValue = document.getElementById('corner-radius-value');
            
            cornerRadiusSlider.addEventListener('input', (e) => {
                cornerRadiusValue.textContent = e.target.value;
                const viewBox = document.querySelector('.cropper-view-box');
                const face = document.querySelector('.cropper-face');
                if (viewBox && face) {
                    const radius = e.target.value / 2;
                    viewBox.style.borderRadius = `${radius}%`;
                    face.style.borderRadius = `${radius}%`;
                }
            });

            logoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropModal.classList.remove('hidden');
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, { 
                        viewMode: 1, background: false, autoCrop: true, movable: true, zoomable: true,
                        ready: () => { cornerRadiusSlider.dispatchEvent(new Event('input')); }
                    });
                    cornerRadiusSlider.value = 0;
                    cornerRadiusValue.textContent = 0;
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            });

            function closeCropper() {
                cropModal.classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                editingObject = null;
            }

            cancelCropBtn.addEventListener('click', closeCropper);
            replaceBtnModal.addEventListener('click', () => logoUpload.click());

            doneCropBtn.addEventListener('click', () => {
                if (!cropper) return;

                const sourceCanvas = cropper.getCroppedCanvas();
                const radiusPercent = parseInt(cornerRadiusSlider.value, 10);
                const maxRadius = Math.min(sourceCanvas.width, sourceCanvas.height) / 2;
                const radius = maxRadius * (radiusPercent / 100);

                const destCanvas = document.createElement('canvas');
                destCanvas.width = sourceCanvas.width;
                destCanvas.height = sourceCanvas.height;
                const ctx = destCanvas.getContext('2d');

                ctx.beginPath();
                ctx.moveTo(radius, 0);
                ctx.lineTo(destCanvas.width - radius, 0);
                ctx.arcTo(destCanvas.width, 0, destCanvas.width, radius, radius);
                ctx.lineTo(destCanvas.width, destCanvas.height - radius);
                ctx.arcTo(destCanvas.width, destCanvas.height, destCanvas.width - radius, destCanvas.height, radius);
                ctx.lineTo(radius, destCanvas.height);
                ctx.arcTo(0, destCanvas.height, 0, destCanvas.height - radius, radius);
                ctx.lineTo(0, radius);
                ctx.arcTo(0, 0, radius, 0, radius);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(sourceCanvas, 0, 0);

                const finalImageDataUrl = destCanvas.toDataURL('image/png');

                if (editingObject) {
                    canvas.remove(editingObject);
                }

                fabric.Image.fromURL(finalImageDataUrl, (img) => {
                    img.scaleToWidth(editingObject ? editingObject.getScaledWidth() : 150);
                    img.set({
                        left: editingObject ? editingObject.left : canvas.width / 2,
                        top: editingObject ? editingObject.top : canvas.height / 2,
                        angle: editingObject ? editingObject.angle : 0,
                        originX: 'center', originY: 'center', customType: 'image',
                        originalSrc: imageToCrop.src, cornerRadiusPercent: radiusPercent
                    });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                });
                closeCropper();
            });

            // --- GENERAL CONTROLS (REMOVE, SELECTION, DOUBLE CLICK) ---
            const removeBtn = document.getElementById('remove-btn');
            removeBtn.addEventListener('click', () => {
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects.length) {
                    activeObjects.forEach(object => canvas.remove(object));
                    canvas.discardActiveObject().renderAll();
                }
            });
            
            function handleSelectionChange() {
                const activeObject = canvas.getActiveObject();
                removeBtn.disabled = !activeObject;
                updateDynamicControls(activeObject);
            }

            canvas.on({
                'selection:created': handleSelectionChange,
                'selection:updated': handleSelectionChange,
                'selection:cleared': handleSelectionChange,
                'mouse:dblclick': (e) => {
                    if (e.target && e.target.customType === 'image') {
                        editingObject = e.target;
                        imageToCrop.src = editingObject.originalSrc;
                        cropModal.classList.remove('hidden');
                        if (cropper) cropper.destroy();
                        const savedRadius = editingObject.cornerRadiusPercent || 0;
                        cornerRadiusSlider.value = savedRadius;
                        cornerRadiusValue.textContent = savedRadius;
                        cropper = new Cropper(imageToCrop, {
                            viewMode: 1, background: false, autoCrop: true, movable: true, zoomable: true,
                            ready: () => { cornerRadiusSlider.dispatchEvent(new Event('input')); }
                        });
                    }
                }
            });
            
            window.addEventListener('keydown', (e) => {
                if ((e.key === 'Delete' || e.key === 'Backspace') && document.activeElement.tagName !== 'INPUT') {
                    const activeObjects = canvas.getActiveObjects();
                    if (activeObjects.length) {
                        activeObjects.forEach(object => canvas.remove(object));
                        canvas.discardActiveObject().renderAll();
                    }
                }
            });

            // --- Snapping Logic ---
            const snappingThreshold = 10;
            canvas.on('object:moving', (options) => {
              const obj = options.target;
              obj.set({ originX: 'center', originY: 'center' });
              const canvasCenterX = canvas.getCenter().left;
              const designCenterY = canvas.height / 2;
              const objCenter = obj.getCenterPoint();

              if (Math.abs(objCenter.x - canvasCenterX) < snappingThreshold) {
                  obj.set({ left: canvasCenterX }).setCoords();
              }
              if (Math.abs(objCenter.y - designCenterY) < snappingThreshold) {
                  obj.set({ top: designCenterY }).setCoords();
              }
            });
            
            // --- Initial Population ---
            populateFontGallery();
            populateEmojiGallery();
        });
    </script>
</body>
</html>
